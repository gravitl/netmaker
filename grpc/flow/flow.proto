syntax = "proto3";

package netmaker.flow;

option go_package = "github.com/gravitl/netmaker/grpc/flow";

// ============================================================
// BUILD COMMAND:
//
// protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative grpc/flow/flow.proto
//
// ============================================================

// ============================================================
// ENUMS
// ============================================================

/**
 * Lifecycle stage of a flow event as seen by an agent.
 * A flow produces:
 *  - EVENT_START   when conntrack entry is created
 *  - EVENT_DESTROY when conntrack entry is removed
 */
enum EventType {
  EVENT_TYPE_UNSPECIFIED = 0;
  EVENT_START = 1;
  EVENT_DESTROY = 2;
}

/**
 * Identifies what kind of participant an IP belongs to.
 * This is assigned on the server during enrichment.
 */
enum ParticipantType {
  PARTICIPANT_UNSPECIFIED = 0;
  PARTICIPANT_HOST = 1;
  PARTICIPANT_USER = 2;
  PARTICIPANT_EXTCLIENT = 3;
  PARTICIPANT_EXTERNAL = 4; // anything not part of the Netmaker network
}

/**
 * Direction of the flow relative to the observing node (agent).
 */
enum Direction {
  DIR_UNSPECIFIED = 0;
  DIR_INGRESS = 1;
  DIR_EGRESS = 2;
}

// ============================================================
// PARTICIPANT STRUCTURE
// ============================================================

/**
 * Fully enriched representation of one endpoint of a flow.
 * The server fills this in before inserting into ClickHouse.
 */
message FlowParticipant {
  string ip = 1;                          // normalized IPv4 or IPv6
  ParticipantType participant_type = 2;   // host/user/extclient/external
  string participant_id = 3;              // UUID for host/user/extclient; empty for external
}

// ============================================================
// RAW AGENT EVENT
// ============================================================

/**
 * Raw flow lifecycle event generated by an agent.
 * The agent sends FULL data on both START and DESTROY events.
 * The server enriches this event and stores the enriched version.
 */
message FlowEvent {
  // Flow lifecycle event type (START or DESTROY)
  EventType type = 1;

  // Stable identity (used as ClickHouse merge key)
  string flow_id = 2;        // unique per flow
  string network_id = 3;     // Netmaker network the flow belongs to
  string host_id = 4;        // node reporting this event (observer)

  // L3/L4 metadata
  uint32 protocol = 5;       // IP protocol number
  uint32 src_port = 6;
  uint32 dst_port = 7;
  uint32 icmp_type = 8;
  uint32 icmp_code = 9;

  Direction direction = 10;

  // Flow participants (raw, before enrichment)
  string src_ip = 11;        // raw source IP string
  string dst_ip = 12;        // raw destination IP string

  // Timestamps (milliseconds since epoch)
  int64 start_ts_ms = 13;    // first-packet timestamp (agent clock)
  int64 end_ts_ms = 14;      // last-packet timestamp (only for destroy)

  // Traffic counters (only valid for destroy events)
  uint64 bytes_sent = 15;
  uint64 bytes_recv = 16;
  uint64 packets_sent = 17;
  uint64 packets_recv = 18;

  // Netfilter conntrack status flags (bitmask)
  uint32 status = 19;

  /**
   * Version used by ClickHouse for merging.
   * Must be strictly increasing for START → DESTROY.
   * Usually equal to the agent event timestamp (ms).
   */
  int64 version = 20;
}

// ============================================================
// ENRICHED FLOW RECORD (server-side)
// ============================================================

/**
 * Fully enriched flow entry written to ClickHouse.
 * This is a complete single-row representation of a flow event.
 * The server merges FlowEvent + enrichment → FlowRecord.
 */
message FlowRecord {
  // Identity (same fields as FlowEvent)
  string flow_id = 1;
  string network_id = 2;
  string host_id = 3;

  // Fully enriched participants
  FlowParticipant src = 4;
  FlowParticipant dst = 5;

  // Protocol metadata
  uint32 protocol = 6;
  uint32 src_port = 7;
  uint32 dst_port = 8;
  uint32 icmp_type = 9;
  uint32 icmp_code = 10;

  Direction direction = 11;

  // Timestamps
  int64 start_ts_ms = 12;
  int64 end_ts_ms = 13;

  // Counters
  uint64 bytes_sent = 14;
  uint64 bytes_recv = 15;
  uint64 packets_sent = 16;
  uint64 packets_recv = 17;

  // Conntrack flags
  uint32 status = 18;

  // Same version assigned by agent; used by ClickHouse to pick latest
  int64 version = 19;
}

// ============================================================
// BATCHING AND STREAMING
// ============================================================

/**
 * Envelope sent by agents containing multiple FlowEvents.
 * Allows batching and efficient streaming.
 */
message FlowEnvelope {
  string host_id = 1;         // identifier of the sending agent
  string network_id = 2;      // network this batch belongs to
  uint64 seq = 3;             // monotonically increasing batch number
  repeated FlowEvent events = 4;
  int64 batch_ts_ms = 5;      // when agent formed the batch
}

/**
 * Response from server acknowledging receipt of a batch.
 */
message FlowResponse {
  uint64 ack_seq = 1;         // matching the seq in FlowEnvelope
  bool success = 2;           // true if batch was accepted
  string error = 3;           // optional error information
}

// ============================================================
// SERVICE
// ============================================================

/**
 * Bidirectional streaming:
 *  - Agents continuously send FlowEnvelope batches.
 *  - Server replies with FlowResponse ACKs.
 */
service FlowService {
  rpc StreamFlows(stream FlowEnvelope) returns (stream FlowResponse);
}
